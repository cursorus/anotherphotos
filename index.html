<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Album Viewer</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

```
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: #000;
        color: #fff;
        padding: 20px;
    }

    .container {
        max-width: 1400px;
        margin: 0 auto;
    }

    h1 {
        text-align: center;
        margin-bottom: 30px;
        font-size: 2em;
    }

    .status {
        text-align: center;
        padding: 20px;
        background: #1a1a1a;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .gallery {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
    }

    .media-item {
        background: #1a1a1a;
        border-radius: 8px;
        overflow: hidden;
        cursor: pointer;
        transition: transform 0.2s;
    }

    .media-item:hover {
        transform: scale(1.05);
    }

    .media-item img,
    .media-item video {
        width: 100%;
        height: 250px;
        object-fit: cover;
        display: block;
    }

    .media-info {
        padding: 10px;
        font-size: 0.9em;
        color: #aaa;
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.95);
        z-index: 1000;
        padding: 20px;
    }

    .modal.active {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        max-width: 90%;
        max-height: 90%;
    }

    .modal-content img,
    .modal-content video {
        max-width: 100%;
        max-height: 85vh;
        object-fit: contain;
    }

    .close-modal {
        position: absolute;
        top: 20px;
        right: 40px;
        font-size: 40px;
        color: #fff;
        cursor: pointer;
        z-index: 1001;
    }

    .error {
        color: #ff4444;
        text-align: center;
        padding: 20px;
        background: #2a1a1a;
        border-radius: 8px;
        margin: 20px 0;
    }

    .config-form {
        background: #1a1a1a;
        padding: 30px;
        border-radius: 8px;
        margin-bottom: 30px;
    }

    .config-form label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
    }

    .config-form input {
        width: 100%;
        padding: 12px;
        background: #2a2a2a;
        border: 1px solid #444;
        border-radius: 4px;
        color: #fff;
        font-size: 14px;
        margin-bottom: 15px;
    }

    .config-form button {
        width: 100%;
        padding: 14px;
        background: #0066ff;
        border: none;
        border-radius: 4px;
        color: #fff;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
    }

    .config-form button:hover {
        background: #0052cc;
    }

    .config-form button:disabled {
        background: #444;
        cursor: not-allowed;
    }

    .button-group {
        display: flex;
        gap: 10px;
        margin-top: 10px;
    }

    .button-group button {
        flex: 1;
    }

    .secondary-btn {
        background: #2a2a2a !important;
    }

    .secondary-btn:hover {
        background: #3a3a3a !important;
    }

    .info-box {
        background: #1a3a1a;
        padding: 15px;
        border-radius: 4px;
        margin-top: 20px;
        font-size: 0.9em;
        line-height: 1.6;
    }

    .info-box h3 {
        margin-bottom: 10px;
        color: #4ade80;
    }

    .info-box code {
        background: #2a2a2a;
        padding: 2px 6px;
        border-radius: 3px;
        font-family: monospace;
        font-size: 0.9em;
    }

    .bookmarklet {
        display: inline-block;
        background: #0066ff;
        color: white;
        padding: 8px 16px;
        border-radius: 4px;
        text-decoration: none;
        margin: 10px 0;
        font-weight: 600;
    }

    .loading {
        text-align: center;
        padding: 40px;
    }

    .spinner {
        border: 4px solid #333;
        border-top: 4px solid #fff;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .badge {
        display: inline-block;
        padding: 4px 8px;
        background: #0066ff;
        border-radius: 4px;
        font-size: 0.8em;
        margin-left: 8px;
    }
</style>
```

</head>
<body>
    <div class="container">
        <h1>üñºÔ∏è Album Viewer</h1>

```
    <div class="config-form" id="configForm">
        <h2 style="margin-bottom: 20px;">Configuration</h2>
        
        <label for="gatheringId">Gathering ID (Album ID):</label>
        <input type="text" id="gatheringId" placeholder="0146b8f3-4c0b-4668-bb2a-89bf6b0e6083">
        
        <label for="authSession">Auth Session Token:</label>
        <input type="text" id="authSession" placeholder="Paste your token here or use bookmarklet">
        
        <div class="button-group">
            <button onclick="loadAlbum()">Load Album</button>
            <button class="secondary-btn" onclick="tryAutoDetect()">Try Auto-Detect</button>
        </div>

        <div class="info-box">
            <h3>üì± How to get your token on iPhone:</h3>
            <p><strong>Method 1: Bookmarklet (Recommended)</strong></p>
            <ol>
                <li>Tap and hold this link: <a href="javascript:(function(){const cookies=document.cookie.split(';');const authCookie=cookies.find(c=>c.includes('auth_session'));if(authCookie){const token=authCookie.split('=')[1].trim();prompt('Copy this token:',token);}else{alert('Token not found! Make sure you are logged in to joinswsh.com');}})();" class="bookmarklet">üìã Get Token</a></li>
                <li>Choose "Add Bookmark" ‚Üí Save to Favorites</li>
                <li>Open <code>joinswsh.com</code> in Safari</li>
                <li>Tap the bookmark ‚Üí Copy the token</li>
                <li>Paste it above!</li>
            </ol>
            
            <p style="margin-top: 15px;"><strong>Method 2: Manual</strong></p>
            <ol>
                <li>Open Safari on iPhone</li>
                <li>Go to <code>joinswsh.com</code> and log in</li>
                <li>Open Safari Settings ‚Üí Advanced ‚Üí Web Inspector</li>
                <li>Connect to Mac and use Web Inspector to view cookies</li>
            </ol>

            <p style="margin-top: 15px;"><strong>Method 3: Save Token</strong></p>
            <p>Once you paste the token once, click "Save Token" below to remember it!</p>
        </div>
    </div>

    <div class="status" id="status" style="display: none;"></div>
    
    <div class="gallery" id="gallery"></div>

    <div class="modal" id="modal" onclick="closeModal()">
        <span class="close-modal" onclick="closeModal()">&times;</span>
        <div class="modal-content" id="modalContent"></div>
    </div>
</div>

<script>
    const API_URL = 'https://multi-region-prod-graphql.joinswsh.com/graphql';
    let allMedia = [];
    let currentConfig = {
        gatheringId: '',
        authSession: ''
    };

    // Load saved config on page load
    window.addEventListener('DOMContentLoaded', () => {
        const savedGatheringId = localStorage.getItem('gatheringId');
        const savedAuthSession = localStorage.getItem('authSession');
        
        if (savedGatheringId) {
            document.getElementById('gatheringId').value = savedGatheringId;
        }
        if (savedAuthSession) {
            document.getElementById('authSession').value = savedAuthSession;
        }
    });

    function tryAutoDetect() {
        showStatus('üîç Trying to detect token...', false);
        
        // Try to read cookie (will only work if on same domain)
        const cookies = document.cookie.split(';');
        const authCookie = cookies.find(c => c.includes('auth_session'));
        
        if (authCookie) {
            const token = authCookie.split('=')[1].trim();
            document.getElementById('authSession').value = token;
            showStatus('‚úÖ Token detected automatically!', false);
        } else {
            showStatus('‚ùå Auto-detect failed. Please use the bookmarklet method (see instructions below) or paste token manually.', true);
        }
    }

    function saveConfig() {
        const gatheringId = document.getElementById('gatheringId').value.trim();
        const authSession = document.getElementById('authSession').value.trim();
        
        if (gatheringId) localStorage.setItem('gatheringId', gatheringId);
        if (authSession) localStorage.setItem('authSession', authSession);
        
        showStatus('üíæ Configuration saved!', false);
    }

    // GraphQL query
    const QUERY = `
        query GetGatheringAndPhotos($input: GetGatheringInput!, $photosInput: GatheringPhotosInput) {
            getGathering(input: $input) {
                gatheringId
                numPhotos
                photos(input: $photosInput) {
                    cursor
                    payload {
                        photoId
                        ownerId
                        width
                        height
                        variant
                        videoDuration
                        readUrl {
                            v0TemplateUrl
                            videoStrategy
                        }
                    }
                }
            }
        }
    `;

    function showStatus(message, isError = false) {
        const status = document.getElementById('status');
        status.style.display = 'block';
        status.textContent = message;
        status.style.background = isError ? '#2a1a1a' : '#1a1a1a';
        status.style.color = isError ? '#ff4444' : '#fff';
    }

    function showLoading(show = true) {
        const status = document.getElementById('status');
        if (show) {
            status.style.display = 'block';
            status.innerHTML = '<div class="spinner"></div><p>Loading album...</p>';
        }
    }

    async function fetchPhotos(cursor = null) {
        const response = await fetch(API_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'authorization': `Bearer ${currentConfig.authSession}`,
                'x-operation-version': 'v0.0.2',
                'x-operation-hash': 'e2bd15ab063fc6f0949a545a581e536260a7cb10f8c0b2244261b8ec00bdfc47',
                'x-client-version': '1.1.15',
                'x-branch': 'prod'
            },
            body: JSON.stringify({
                operationName: 'GetGatheringAndPhotos',
                variables: {
                    input: { gatheringId: currentConfig.gatheringId },
                    photosInput: {
                        cursor: cursor,
                        limit: 50,
                        filterUserIds: [],
                        filterUploaderIds: [],
                        filterPhotoVariant: [],
                        filterLabels: [],
                        filterRestrictedLabels: [],
                        filterMode: 'Or',
                        filter: 'Active'
                    }
                },
                query: QUERY
            })
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        return await response.json();
    }

    function getMediaUrl(item) {
        const template = item.readUrl.v0TemplateUrl;
        
        if (item.variant === 'Video' || item.variant === 'LivePhoto') {
            // Replace TEMPLATE_PLACEHOLDER with stream/original-video/hls.m3u8
            return template.replace('TEMPLATE_PLACEHOLDER', 'stream/original-video/hls.m3u8');
        } else {
            // For images, use optimize/lg/contain/jpeg
            return template.replace('TEMPLATE_PLACEHOLDER', 'optimize/lg/contain/jpeg');
        }
    }

    function createMediaElement(item) {
        const div = document.createElement('div');
        div.className = 'media-item';
        
        const isVideo = item.variant === 'Video' || item.variant === 'LivePhoto';
        const url = getMediaUrl(item);

        if (isVideo) {
            // Create video element with poster (thumbnail)
            const video = document.createElement('video');
            video.controls = false;
            video.muted = true;
            video.loop = true;
            
            // Try to load HLS
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    video.play().catch(() => {});
                });
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = url;
                video.addEventListener('loadedmetadata', () => {
                    video.play().catch(() => {});
                });
            }
            
            div.appendChild(video);
        } else {
            const img = document.createElement('img');
            img.src = url;
            img.alt = 'Photo';
            img.loading = 'lazy';
            div.appendChild(img);
        }

        const info = document.createElement('div');
        info.className = 'media-info';
        info.innerHTML = `
            ${item.width}√ó${item.height}
            <span class="badge">${item.variant}</span>
            ${item.videoDuration ? `<span class="badge">${item.videoDuration.toFixed(1)}s</span>` : ''}
        `;
        div.appendChild(info);

        div.onclick = () => openModal(item);

        return div;
    }

    function openModal(item) {
        const modal = document.getElementById('modal');
        const modalContent = document.getElementById('modalContent');
        modalContent.innerHTML = '';

        const isVideo = item.variant === 'Video' || item.variant === 'LivePhoto';
        const url = getMediaUrl(item);

        if (isVideo) {
            const video = document.createElement('video');
            video.controls = true;
            video.autoplay = true;
            
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(video);
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = url;
            }
            
            modalContent.appendChild(video);
        } else {
            const img = document.createElement('img');
            img.src = url;
            img.alt = 'Photo';
            modalContent.appendChild(img);
        }

        modal.classList.add('active');
    }

    function closeModal() {
        const modal = document.getElementById('modal');
        modal.classList.remove('active');
        
        // Stop video playback
        const video = modal.querySelector('video');
        if (video) {
            video.pause();
            if (video.hls) {
                video.hls.destroy();
            }
        }
    }

    async function loadAlbum() {
        const gatheringId = document.getElementById('gatheringId').value.trim();
        const authSession = document.getElementById('authSession').value.trim();

        if (!gatheringId || !authSession) {
            showStatus('Please fill in both fields!', true);
            return;
        }

        currentConfig = { gatheringId, authSession };
        
        // Save config to localStorage
        localStorage.setItem('gatheringId', gatheringId);
        localStorage.setItem('authSession', authSession);
        
        allMedia = [];
        document.getElementById('gallery').innerHTML = '';
        showLoading(true);

        try {
            let cursor = null;
            let totalPhotos = 0;
            let loadedPhotos = 0;

            // Fetch first batch to get total count
            const firstBatch = await fetchPhotos(null);
            const gatheringData = firstBatch.data.getGathering;
            totalPhotos = gatheringData.numPhotos;

            // Process first batch
            const firstPhotos = gatheringData.photos.payload;
            allMedia.push(...firstPhotos);
            loadedPhotos += firstPhotos.length;

            // Render first batch
            renderGallery();
            showStatus(`Loaded ${loadedPhotos} of ${totalPhotos} items...`);

            cursor = gatheringData.photos.cursor;

            // Fetch remaining batches
            while (cursor) {
                const batch = await fetchPhotos(cursor);
                const photos = batch.data.getGathering.photos.payload;
                
                if (photos.length === 0) break;

                allMedia.push(...photos);
                loadedPhotos += photos.length;
                
                renderGallery();
                showStatus(`Loaded ${loadedPhotos} of ${totalPhotos} items...`);

                cursor = batch.data.getGathering.photos.cursor;
            }

            showStatus(`‚úÖ Successfully loaded ${allMedia.length} items!`);
            
            // Hide config form after successful load
            document.getElementById('configForm').style.display = 'none';

        } catch (error) {
            console.error('Error:', error);
            showStatus(`‚ùå Error: ${error.message}`, true);
        }
    }

    function renderGallery() {
        const gallery = document.getElementById('gallery');
        gallery.innerHTML = '';
        
        allMedia.forEach(item => {
            gallery.appendChild(createMediaElement(item));
        });
    }

    // Close modal on Escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeModal();
    });
</script>
```

</body>
</html>
